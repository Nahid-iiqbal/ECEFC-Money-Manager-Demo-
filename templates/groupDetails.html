{% extends "base.html" %}

{% block title %}{{ group.name }} - FinBuddy{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/group.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}

<style>
/* Group settings icon with background and label */
/* Unified group settings button with icon and label */
.group-settings-combo-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
    border: none;
    border-radius: 2rem;
    padding: 0.3rem 1.1rem 0.3rem 0.6rem;
    font-size: 1.1rem;
    font-weight: 500;
    color: #4f46e5;
    position: absolute;
    right: 2.5rem;
    top: 1.2rem;
    z-index: 2;
    box-shadow: 0 2px 8px rgba(99,102,241,0.08);
    cursor: pointer;
    transition: background 0.2s, color 0.2s, box-shadow 0.2s;
}
.group-settings-combo-btn:hover {
    background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%);
    color: #fff;
    box-shadow: 0 4px 16px rgba(99,102,241,0.18);
}
.group-settings-combo-btn .icon {
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
}
.group-settings-combo-btn .label {
    font-size: 1.05rem;
    font-weight: 500;
    letter-spacing: 0.01em;
    color: inherit;
    background: none;
    padding: 0;
    margin: 0;
}
.group-settings-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0; top: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.25);
        align-items: center; justify-content: center;
}
.group-settings-modal.active { display: flex; }
.group-settings-content {
        background: #fff;
        border-radius: 16px;
        padding: 2rem 2.5rem;
        min-width: 320px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.18);
        position: relative;
}
.group-settings-close {
        position: absolute;
        top: 0.7rem;
        right: 1.2rem;
        font-size: 1.5rem;
        background: none;
        border: none;
        cursor: pointer;
        color: #888;
}
.group-settings-close:hover { color: #e74c3c; }
.group-settings-content h3 { margin-top: 0; }
.group-settings-content form { margin-bottom: 1.2rem; }

/* Modern button styles for modal */
.modal-btn {
    display: block;
    width: 100%;
    padding: 0.7rem 0;
    margin-bottom: 0.7rem;
    border: none;
    border-radius: 8px;
    font-size: 1.08rem;
    font-weight: 500;
    letter-spacing: 0.01em;
    transition: background 0.18s, color 0.18s, box-shadow 0.18s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    cursor: pointer;
}
.modal-btn-warning {
    background: linear-gradient(90deg, #fbbf24 0%, #f59e42 100%);
    color: #fff;
}
.modal-btn-warning:hover {
    background: linear-gradient(90deg, #f59e42 0%, #fbbf24 100%);
    color: #fff;
}
.modal-btn-primary {
    background: linear-gradient(90deg, #667eea 0%, #5ed88f 100%);
    color: #fff;
}
.modal-btn-primary:hover {
    background: linear-gradient(90deg, #5ed88f 0%, #667eea 100%);
    color: #fff;
}
.modal-btn-danger {
    background: linear-gradient(90deg, #e74c3c 0%, #f87171 100%);
    color: #fff;
}
.modal-btn-danger:hover {
    background: linear-gradient(90deg, #f87171 0%, #e74c3c 100%);
    color: #fff;
}
.kick-member-form {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.7rem;
}
/* Modern dropdown style for modal */
.kick-member-form select,
select[name="new_admin_id"] {
    flex: 1;
    width: 100%;
    padding: 0.5rem 0.7rem;
    border-radius: 8px;
    border: 1.5px solid #c7d2fe;
    background: #f3f4f6;
    color: #3730a3;
    font-size: 1rem;
    font-weight: 500;
    margin-bottom: 0.2rem;
    transition: border 0.18s, box-shadow 0.18s;
    box-shadow: 0 1px 4px rgba(99,102,241,0.04);
}
.kick-member-form select:focus,
select[name="new_admin_id"]:focus {
    outline: none;
    border: 1.5px solid #6366f1;
    box-shadow: 0 2px 8px rgba(99,102,241,0.10);
}
</style>

<div id="groupSettingsModal" class="group-settings-modal">
    <div class="group-settings-content">
        <button class="group-settings-close" onclick="closeGroupSettingsModal()">&times;</button>
        <h3 style="color:#4f46e5;letter-spacing:0.01em;font-weight:600;">Group Settings</h3>
        <form method="POST" action="{{ url_for('group.leave_group', group_id=group.id) }}">
            <button type="submit" class="modal-btn modal-btn-warning">üö™ Leave Group</button>
        </form>
        {% if group.created_by == current_user.id and members|length > 1 %}
        <form method="POST" action="{{ url_for('group.transfer_admin', group_id=group.id) }}">
            <div style="margin-bottom:0.5rem;">
                <select name="new_admin_id" required style="width:100%;padding:0.4rem;">
                    <option value="" disabled selected>Transfer admin to...</option>
                    {% for member in members %}
                        {% if member.id != current_user.id %}
                        <option value="{{ member.id }}">{{ member.name }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="modal-btn modal-btn-primary">üëë Transfer Admin</button>
        </form>
        <!-- Kick member option -->
        <form method="POST" action="{{ url_for('group.kick_member', group_id=group.id) }}" class="kick-member-form">
            <select name="kick_user_id" required>
                <option value="" disabled selected>Kick member...</option>
                {% for member in members %}
                    {% if member.id != current_user.id %}
                    <option value="{{ member.id }}">{{ member.name }}</option>
                    {% endif %}
                {% endfor %}
            </select>
            <button type="submit" class="modal-btn modal-btn-danger" style="margin-bottom:0;">ü¶∂ Kick</button>
        </form>
        {% endif %}
    </div>
</div>
<script>
function openGroupSettingsModal() {
    document.getElementById('groupSettingsModal').classList.add('active');
}
function closeGroupSettingsModal() {
    document.getElementById('groupSettingsModal').classList.remove('active');
}
window.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeGroupSettingsModal();
});
window.addEventListener('click', function(e) {
    const modal = document.getElementById('groupSettingsModal');
    if (e.target === modal) closeGroupSettingsModal();
});
</script>

{% if members|length == 0 %}
<form method="POST" action="{{ url_for('group.delete_group', group_id=group.id) }}" onsubmit="return confirm('Are you sure you want to delete this group? This action cannot be undone.');">
    <button type="submit" class="btn btn-danger" style="margin-bottom: 1rem;">üóëÔ∏è Delete Group</button>
</form>
{% endif %}
<div class="dashboard-header group-header" data-group-id="{{ group.id }}" style="position:relative;">
    <button class="group-settings-combo-btn" title="Group Settings" onclick="openGroupSettingsModal()">
        <span class="icon">‚öôÔ∏è</span>
        <span class="label">Group Settings</span>
    </button>
    <a href="{{ url_for('group.my_groups') }}" class="back-link">‚Üê Back</a>
    <h2 class="flicker">{{ group.name }}</h2>
    <div class="invite-pill">
        <span>Invite Code:</span>
        <strong class="selectable">{{ group.join_code }}</strong>
    </div>
</div>

<div class="summary-cards">
    <div class="summary-card card-green" data-field="total-expense-card">
        <div class="card-icon">üí∏</div>
        <div class="card-content">
            <h3>Total Spent</h3>
            <p class="card-subtitle">Entire Group</p>
            <p class="card-amount" data-field="total-expense">‡ß≥{{ "%.2f"|format(total_group_expense) }}</p>
        </div>
    </div>

    <div class="summary-card card-purple action-card" onclick="window.location.href='{{ url_for('expense.add_expense_form', type='Group', group_id=group.id) }}';">
        <div class="card-icon">‚ûï</div>
        <div class="card-content">
            <h3>Add Expense</h3>
            <p class="card-subtitle">Split with group</p>
        </div>
    </div>
</div>

{% if settlements %}
<div class="recent-activity-section settlements-section">
    <h3>üí∏ Settlements Needed</h3>
    <p class="section-subtitle">Simplify payments with these transactions</p>
    <div class="activity-list" data-field="settlements">
        {% for settlement in settlements %}
        <div class="activity-item settlement-item">
            <div class="activity-icon {% if settlement.from == current_user.username %}personal{% else %}group{% endif %}">
                üîÑ
            </div>
            <div class="activity-details">
                <div class="activity-header">
                    <span class="activity-type badge-{% if settlement.from == current_user.username %}personal{% else %}blue{% endif %}">
                        {{ settlement.from }} ‚Üí {{ settlement.to }}
                    </span>
                    {% if settlement.from == current_user.username %}
                    <span class="activity-date badge-personal">You owe</span>
                    {% elif settlement.to == current_user.username %}
                    <span class="activity-date badge-green">You get</span>
                    {% endif %}
                </div>
                <p class="activity-description">
                    {% if settlement.from == current_user.username %}
                        You need to pay {{ settlement.to }}
                    {% elif settlement.to == current_user.username %}
                        {{ settlement.from }} needs to pay you
                    {% else %}
                        Settlement between members
                    {% endif %}
                </p>
            </div>
            <div class="activity-amount {% if settlement.to == current_user.username %}positive{% else %}negative{% endif %}">
                {% if settlement.to == current_user.username %}+{% endif %}‡ß≥{{ "{:.2f}".format(settlement.amount) }}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="details-grid">
    <div class="recent-activity-section members-section">
        <h3>üë• Member Contributions</h3>
        <div class="activity-list" data-field="members-list">
            {% for member in members %}
            <div class="activity-item member-item">
                <div class="activity-icon group">
                    {{ member.name[:1] }}
                </div>
                <div class="activity-details">
                    <div class="activity-header">
                        <span class="activity-type badge-group">{{ member.name }}</span>
                        {% if member.name == current_user.username %}
                        <span class="activity-date">(You)</span>
                        {% endif %}
                    </div>
                    <div class="contribution-bar-container">
                        {% set percentage = (member.total / total_group_expense * 100) if total_group_expense > 0 else 0 %}
                        <div class="contribution-bar" style="width: {{ '%.1f'|format(percentage) }}%"></div>
                    </div>
                    <p class="activity-description">{{ member.count }} Transactions</p>
                </div>
                <div class="activity-amount">‡ß≥{{ "%.2f"|format(member.total) }}</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="recent-activity-section">
        <h3>üìú Group History</h3>
        {% if group.expenses %}
            <div class="activity-list" data-field="expenses-list">
                {% for exp in group.expenses|sort(attribute='date', reverse=True) %}
                <div class="activity-item">
                    <div class="activity-icon personal">üßæ</div>
                    <div class="activity-details">
                        <div class="activity-header">
                            <span class="activity-type badge-personal">{{ exp.payer.username }} paid</span>
                            <span class="activity-date">{{ exp.date.strftime('%Y-%m-%d') }}</span>
                        </div>
                        <p class="activity-description">{{ exp.description }}</p>
                    </div>
                    <div class="activity-amount">‡ß≥{{ exp.amount }}</div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <p class="empty-text">No expenses yet.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Script to join group room on page load -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const groupId = document.querySelector('[data-group-id]')?.getAttribute('data-group-id');
        if (groupId && socket) {
            joinGroupRoom(parseInt(groupId));
            // Request initial group data
            requestGroupUpdate(parseInt(groupId));
        }
    });

    // On page unload, leave group room
    window.addEventListener('beforeunload', function() {
        const groupId = document.querySelector('[data-group-id]')?.getAttribute('data-group-id');
        if (groupId && socket) {
            leaveGroupRoom(parseInt(groupId));
        }
    });
</script>
{% endblock %}
