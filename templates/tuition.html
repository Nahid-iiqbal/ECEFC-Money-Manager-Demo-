{% extends "base.html" %}

{% block title %}Tuition - FeinBuddy{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/tuition.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="expense-page">
    <div class="page-header">
        <h1 class="page-title">üéì Tuition Management</h1>
        <p class="page-subtitle">Track your student classes and schedule efficiently</p>
        <div class="header-stats">
            <div class="stat-item">
                <span class="stat-label">Total Students</span>
                <span class="stat-value">{{ total_students }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Progress Today</span>
                <span class="stat-value">{{ total_completed_classes }}/{{ total_classes }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Total Fees</span>
                <span class="stat-value">‡ß≥{{ total_amount }}</span>
            </div>
        </div>
    </div>

    <div class="tuition-layout">
        <!-- Left Panel: Tuition List -->
        <div class="left-panel">
            <div class="panel-header">
                <div>
                    <h2 class="section-title">üìö Your Students</h2>
                    <p class="section-subtitle">Manage and track all tuition records</p>
                </div>
                <a href="{{ url_for('tuition.add_tuition') }}" class="btn-add-compact">
                    ‚ûï Add New Student
                </a>
            </div>
            
            {% if tuition_list %}
                <div class="tuition-list-scrollable">
                    {% for entry in tuition_list %}
                        <div class="tuition-entry">
                            <div class="tuition-details">
                                <div class="student-header">
                                    <h3 class="student-name-header">üë§ {{ entry.student_name }}</h3>
                                    <span class="tuition-fee">‡ß≥{{ (entry.amount / entry.total_days) | round(2) }}/class</span>
                                </div>
                                <div class="progress-section">
                                    <div class="progress-info">
                                        <span class="progress-label">Classes Completed</span>
                                        <span class="progress-text">{{ entry.total_completed }}/{{ entry.total_days }}</span>
                                    </div>
                                    <div class="progress-bar-wrapper">
                                        {% set progress_percent = (entry.total_completed / entry.total_days * 100) | round(0) | int if entry.total_days > 0 else 0 %}
                                        <div class="progress-bar-fill" style="width: {{ progress_percent }}%;">
                                            <span class="progress-percentage">{{ progress_percent }}%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="entry-meta">
                                    <div class="meta-item">
                                        <span class="meta-icon">üìç</span>
                                        <span class="meta-text">{{ entry.address }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="entry-actions">
                                <a href="{{ url_for('tuition.reschedule_class', record_id=entry.id) }}" class="action-btn reschedule-btn" title="Reschedule this class">
                                    <span class="action-icon">üìÖ</span>
                                    <span class="action-text">Reschedule</span>
                                </a>
                                <a href="{{ url_for('tuition.edit_tuition', record_id=entry.id) }}" class="action-btn edit-btn" title="Edit student details">
                                    <span class="action-icon">‚úèÔ∏è</span>
                                    <span class="action-text">Edit</span>
                                </a>
                                <form method="POST" action="{{ url_for('tuition.delete_tuition', record_id=entry.id) }}" style="margin: 0;" class="delete-form">
                                    <button type="submit" class="action-btn delete-btn" onclick="return confirm('Are you sure? This cannot be undone.');" title="Delete this student">
                                        <span class="action-icon">üóëÔ∏è</span>
                                        <span class="action-text">Delete</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <p class="empty-icon">üìö</p>
                    <p class="empty-message">No Students Yet</p>
                    <p class="empty-hint">Start by adding your first tuition student to track their progress</p>
                    <div class="empty-cta">
                        <a href="{{ url_for('tuition.add_tuition') }}" class="btn-empty-action">
                            <span>‚ú®</span>
                            <span>Add Your First Student</span>
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Right Panel: Calendar and Reschedules -->
        <div class="right-panel">
            <!-- Weekly Calendar -->
            <div class="calendar-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 class="section-title" style="margin-bottom: 0;">üìÖ Weekly Schedule</h2>
                    <a href="{{ url_for('tuition.export_routine_pdf') }}" class="btn-export-pdf" title="Export as PDF">
                        üìÑ Export PDF
                    </a>
                </div>
                {% if tuition_list %}
                    <table class="weekly-schedule">
                        <thead>
                            <tr>
                                <th class="day-column">Day</th>
                                <th class="schedule-column">Classes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'] %}
                            {% for day_idx in ordered_days %}
                            <tr {% if day_idx == current_day_index %}class="current-day-row"{% endif %}>
                                <td class="day-name">
                                    <div class="day-header">
                                        <span class="day-name-text">{{ days[day_idx] }}</span>
                                        {% if day_idx == current_day_index %}
                                        <span class="today-badge">Today</span>
                                        {% endif %}
                                        <span class="day-date">{{ ordered_dates[loop.index0].strftime('%d %b %Y') }}</span>
                                    </div>
                                </td>
                                <td class="schedule-cell">
                                    {% if schedule_by_day[day_idx] %}
                                    <div class="schedule-tiles-wrapper">
                                        {% for entry in schedule_by_day[day_idx] %}
                                        <div class="schedule-tile">
                                            <div class="tile-header">
                                                <div class="tile-student">{{ entry.student_name }}</div>
                                            </div>
                                            {% if entry.tuition_time %}
                                            <div class="tile-time">‚è∞ {{ entry.tuition_time }}</div>
                                            {% endif %}
                                            
                                            <div class="tile-actions">
                                                <button type="button" class="btn-tile btn-tick" onclick="incrementProgress({{ entry.id }}, '{{ entry.student_name }}', {{ entry.total_completed }}, {{ entry.total_days }})" {% if entry.total_completed >= entry.total_days %}disabled{% endif %} title="Increment progress">‚úì</button>
                                                <button type="button" class="btn-tile btn-skip" onclick="openRescheduleModal({{ entry.id }}, '{{ entry.student_name }}', '{{ entry.tuition_time }}', {{ entry.amount }}, {{ entry.total_days }})" title="Skip/Reschedule">‚è≠Ô∏è</button>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <span class="empty-day">No classes</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="empty-hint">Add tuition entries to see your schedule</p>
                {% endif %}
            </div>

            <!-- Rescheduled Classes Section -->
            <div class="reschedule-section">
                <h2 class="section-title">üîÑ Recent Reschedules</h2>
                {% if recent_reschedules %}
                    <div class="reschedule-list-compact">
                        {% for reschedule in recent_reschedules %}
                        <div class="reschedule-item-compact">
                            <div class="reschedule-info-compact">
                                <strong>{{ reschedule.tuition.student_name }}</strong>
                                <div class="reschedule-dates-compact">
                                    <span>{{ reschedule.original_date.strftime('%d %b') }}</span>
                                    <span class="arrow-small">‚Üí</span>
                                    <span>{{ reschedule.new_date.strftime('%d %b') }}</span>
                                </div>
                            </div>
                            <div class="reschedule-actions-compact">
                                <span class="status-badge-small status-{{ reschedule.reschedule_status }}">
                                    {% if reschedule.reschedule_status == 'pending' %}‚è≥{% elif reschedule.reschedule_status == 'confirmed' %}‚úì{% elif reschedule.reschedule_status == 'completed' %}‚úÖ{% else %}‚úï{% endif %}
                                </span>
                                {% if reschedule.reschedule_status in ['pending', 'confirmed'] %}
                                <a href="{{ url_for('tuition.edit_reschedule', reschedule_id=reschedule.id) }}" class="btn-reschedule-action btn-edit" title="Edit">‚úèÔ∏è</a>
                                <form method="POST" action="{{ url_for('tuition.mark_reschedule_completed', reschedule_id=reschedule.id) }}" style="display: inline; margin: 0;">
                                    <button type="submit" class="btn-reschedule-action btn-complete" title="Mark Completed" onclick="return confirm('Mark this class as completed? This will also increment the progress counter.');">‚úì</button>
                                </form>
                                <form method="POST" action="{{ url_for('tuition.cancel_reschedule', reschedule_id=reschedule.id) }}" style="display: inline; margin: 0;">
                                    <button type="submit" class="btn-reschedule-action btn-cancel" title="Cancel" onclick="return confirm('Cancel this reschedule?');">‚úï</button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="empty-hint">No recent reschedules</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Reschedule Modal -->
<div id="rescheduleModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-btn" onclick="closeRescheduleModal()">&times;</span>
        <div class="modal-header">
            <h2 id="modalTitle">Reschedule Class?</h2>
        </div>
        <div class="modal-body">
            <div class="random-message-box">
                <p id="randomMessage"></p>
            </div>
            <div class="modal-student-info">
                <p><strong>Student:</strong> <span id="modalStudent"></span></p>
                <p><strong>Time:</strong> <span id="modalTime"></span></p>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn-modal btn-reschedule-confirm" onclick="goToReschedule()">üìÖ Reschedule</button>
            <button type="button" class="btn-modal btn-cancel-modal" onclick="closeRescheduleModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Progress Increment Form (hidden) -->
<form id="progressForm" method="POST" action="" style="display: none;">
    <!-- Hidden form for incrementing progress -->
</form>

<style>
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(2px);
}

.modal-content {
    background-color: var(--bg-card);
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    max-width: 500px;
    width: 90%;
    animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-header {
    margin-bottom: 1.5rem;
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 1rem;
}

.modal-header h2 {
    color: var(--accent-red);
    margin: 0;
    font-size: 1.5rem;
}

.close-btn {
    color: var(--text-secondary);
    float: right;
    font-size: 2rem;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
    transition: color 0.3s ease;
}

.close-btn:hover {
    color: var(--accent-red);
}

.random-message-box {
    background: var(--bg-secondary);
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    border-left: 4px solid var(--accent-orange);
    min-height: 80px;
    display: flex;
    align-items: center;
}

#randomMessage {
    color: var(--text-primary);
    font-size: 1.1rem;
    line-height: 1.6;
    margin: 0;
    font-weight: 500;
}

.modal-student-info {
    background: var(--bg-secondary);
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
}

.modal-student-info p {
    margin: 0.5rem 0;
    color: var(--text-primary);
}

.modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

.btn-modal {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-reschedule-confirm {
    background: linear-gradient(135deg, var(--accent-red), #c0392b);
    color: white;
}

.btn-reschedule-confirm:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
}

.btn-cancel-modal {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 2px solid var(--border-color);
}

.btn-cancel-modal:hover {
    border-color: var(--accent-red);
    color: var(--accent-red);
}

.tile-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
    justify-content: center;
}

.btn-tile {
    flex: 1;
    padding: 0.5rem;
    border: none;
    border-radius: 6px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.btn-tick {
    background: var(--accent-green);
    color: white;
}

.btn-tick:hover:not(:disabled) {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(72, 187, 120, 0.4);
}

.btn-tick:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: var(--text-tertiary);
}

.btn-skip {
    background: var(--accent-orange);
    color: white;
}

.btn-skip:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(246, 173, 85, 0.4);
}

.btn-tile:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.tile-date {
    font-size: 0.8rem;
    color: var(--text-secondary);
    text-align: center;
    margin: 0.25rem 0;
}

.tile-header {
    margin-bottom: 0.5rem;
}

@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        padding: 1.5rem;
    }
    
    .modal-actions {
        flex-direction: column;
    }
    
    .btn-modal {
        width: 100%;
    }
}
</style>

<script>
// Guilt-based messages for skipping classes
function getGuiltMessages(perClassCost) {
    return [
        `üí∏ Ouch! You just burned ${perClassCost} BDT. Hope the skip was worth it.`,
        `üò¨ Congratulations! You just paid ${perClassCost} BDT to do nothing.`,
        `üò≠ Your bank account is crying. That's ${perClassCost} BDT down the drain!`,
        `ü§î Imagine what else you could have bought with ${perClassCost} BDT...`,
        `üéì You're paying ${perClassCost} BDT per class. Calculated decision? Or just lazy?`,
        `‚òï That's ${perClassCost} BDT wasted. One less coffee treat this month.`,
        `‚è∞ At ${perClassCost} BDT per class, is this really worth skipping?`,
        `üí∞ Throwing away ${perClassCost} BDT just to skip? Really?`,
        `üò∞ ${perClassCost} BDT per lesson. Every skip costs you.`,
        `üö´ You invested ${perClassCost} BDT in this class. Skipping = money wasted.`
    ];
}

function getGuiltMessage(totalAmount, totalDays) {
    const perClassCost = Math.round(totalAmount / totalDays);
    
    // If the per-class amount is huge, give a special message
    if (perClassCost > 500) {
        return `‚ö†Ô∏è ARE YOU CRAZY?! That's ${perClassCost} BDT per class down the drain!`;
    }
    
    // Pick a random message from the variations
    const messages = getGuiltMessages(perClassCost);
    return messages[Math.floor(Math.random() * messages.length)];
}

let currentRecordId = null;
let currentRecordPage = null;

function openRescheduleModal(recordId, studentName, tuitionTime, totalAmount, totalDays) {
    currentRecordId = recordId;
    const modal = document.getElementById('rescheduleModal');
    document.getElementById('modalTitle').textContent = '‚ùì ' + studentName + ' - Reschedule Class?';
    document.getElementById('randomMessage').textContent = getGuiltMessage(totalAmount, totalDays);
    document.getElementById('modalStudent').textContent = studentName;
    document.getElementById('modalTime').textContent = tuitionTime || 'Not specified';
    modal.style.display = 'flex';
}

function closeRescheduleModal() {
    const modal = document.getElementById('rescheduleModal');
    modal.style.display = 'none';
    currentRecordId = null;
}

function goToReschedule() {
    if (currentRecordId) {
        window.location.href = `/tuition/reschedule/${currentRecordId}`;
    }
}

function incrementProgress(recordId, studentName, completed, total) {
    if (completed >= total) {
        alert('‚úì All classes completed for ' + studentName + '!');
        return;
    }
    
    const form = document.getElementById('progressForm');
    form.action = `/tuition/update-completed/${recordId}/increment`;
    form.method = 'POST';
    
    // Show confirmation with progress update info
    const newProgress = completed + 1;
    if (confirm(`Increment ${studentName}'s progress to ${newProgress}/${total}?`)) {
        form.submit();
    }
}

// Close modal when clicking outside of it
window.onclick = function(event) {
    const modal = document.getElementById('rescheduleModal');
    if (event.target == modal) {
        closeRescheduleModal();
    }
}
</script>
{% endblock %}